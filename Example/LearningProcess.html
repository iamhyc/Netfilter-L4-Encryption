<p>
    1.<br/>
</p>
<p style="margin-top: 0px; margin-bottom: 1.1em; padding: 0px; box-sizing: border-box; color: rgb(85, 85, 85); font-family: &#39;microsoft yahei&#39;; font-size: 14px; line-height: 35px; orphans: 2; white-space: normal; widows: 2;">
    <em style="box-sizing: border-box;">总的说来，整个Linux内核中Netfilter框架的HOOK机制可以概括如下：</em>
</p>
<p style="margin-top: 0px; margin-bottom: 1.1em; padding: 0px; box-sizing: border-box; color: rgb(85, 85, 85); font-family: &#39;microsoft yahei&#39;; font-size: 14px; line-height: 35px; orphans: 2; white-space: normal; widows: 2;">
    <strong style="box-sizing: border-box;">在数据包流经内核协议栈的整个过程中，在一些已预定义的关键点上PRE_ROUTING、LOCAL_IN、FORWARD、LOCAL_OUT和POST_ROUTING会根据数据包的协议簇到这些关键点去查找是否注册有钩子函数。如果没有，则直接返回okfn函数指针所指向的函数继续走协议栈；如果有，则调用nf_hook_slow函数，从而进入到Netfilter框架中去进一步调用已注册在该过滤点下的钩子函数，再根据其返回值来确定是否继续执行由函数指针okfn所指向的函数。</strong>
</p>
<p>
    2.【无用的图片已删】
</p>
<p>
    <br/>
</p>
<p>
    3.<br/>
</p>
<p>
    <a href="http://bbs.chinaunix.net/thread-1941060-1-1.html" _src="http://bbs.chinaunix.net/thread-1941060-1-1.html">http://bbs.chinaunix.net/thread-1941060-1-1.html</a>
</p>
<p>
    iperf, sendip, netfilter
</p>
<p>
    <br/>
</p>
<p>
    4. 关于sk_buff
</p>
<p>
    <strong>skb_headroom(sk_buff *)</strong>: return int
</p>
<p>
    <strong>skb_tailroom(sk_buff *)</strong>: return int
</p>
<p>
    <strong>skb_put(skb_buff *, int)</strong>：向tail room方向拓展data room<br/>
</p>
<p>
    <strong>skb_push(skb_buff *, int)</strong>：向head room方向拓展data room
</p>
<p>
    其余略<br/>
</p>
<p>
    <strong>tcp_transmit_skb</strong>：用(sock *)构造一个TCP头部
</p>
<p>
    <strong>ip_build_and_send_pkt</strong>：用( sock *)构造IP头部并发送给链路层<br/>
</p>
<p>
    <strong>eth_header</strong>：用(net_device *)构造以太网帧协议头<br/>
</p>
<p>
    <br/>
</p>
<p>
    skb_get_ktime(skb_buff *): 返回skb的tstamp
</p>
<p>
    skb_timestamp_set(skb_buff *): 设置时间戳；由ktime_get_real()得到
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    5. 需求确认：
</p>
<p>
    1) 点对点，以及在支持功能的链路上可广播；
</p>
<p>
    2) L2和L3，只修改checksum，确保routing，L4头部到content尾部全部加密
</p>
<p>
    3) 加密算法要尽量快+密钥快速迭代+分发机制
</p>
<p>
    <span style="line-height: 1.6;"><br/></span>
</p>
<p>
    <span style="line-height: 1.6;">&nbsp;&nbsp;&nbsp;&nbsp;Solution:</span>
</p>
<ul class=" list-paddingleft-2" style="list-style-type: disc;">
    <li>
        <p>
            <span style="line-height: 1.6;">NF_IP_LOCAL_IN处HOOK处理接收包</span>
        </p>
    </li>
    <li>
        <p>
            <span style="line-height: 1.6;">NF_IP_LOCAL_OUT处HOOK处理发送包，L3的header-&gt;destip为define常量列表之一时</span>
        </p>
    </li>
    <li>
        <p>
            <span style="line-height: 1.6;">&nbsp; L4+L7长度: &nbsp;n</span><span style="line-height: 1.6;">tohs(iph-&gt;tot_len) &nbsp;-&nbsp;sizeof(struct&nbsp;iphdr)</span>
        </p>
    </li>
    <li>
        <p>
            <span style="line-height: 1.6;">面对L3的payload进行加密</span>
        </p>
    </li>
    <li>
        <p>
            只面向IPv4协议，重新计算L3的checksum
        </p>
    </li>
    <ul class=" list-paddingleft-2" style="list-style-type: square;">
        <li>
            <p>
                IPv4, One&#39;s complement sum: iph除checksum段以外，按顺序16位一组循环相加（进位补到低位运算），结果取反；
            </p>
        </li>
    </ul>
</ul>
<p>
    <br/>
</p>
<p>
    6. TODO
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412155394_733094" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>完成模块对LOCAL_IN和LOCAL_OUT的HOOK，并测试printk</label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412313535_527450" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/><span class="wiz-todo-tail"></span>模块加载，输出L3的完整payload（L4为ICMP包）</label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412204388_46704" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>AES基于openSSL的加密&amp;解密封装</label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412239394_833128" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>在模块头文件中，可指定IP？</label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412293458_89780" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>改变payload的尾部字节，并重新计算checksum，并通过链路验证<span class="wiz-todo-tail"></span></label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412273296_737373" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>模块中调用AES加密payload（注意ntohs，hston）</label>
</p>
<p>
    <label class="wiz-todo-label wiz-todo-label-unchecked"><img id="wiz_todo_1475412436006_198858" class="wiz-todo-img wiz-img-cannot-drag" src="/usr/share/wiznote/skins/default/unchecked.png" state="unchecked" _src="/usr/share/wiznote/skins/default/unchecked.png"/>单元测试<span class="wiz-todo-tail"></span></label>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>
<p>
    <br/>
</p>